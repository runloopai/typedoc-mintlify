name: Semantic Pull Request

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  validate:
    name: Validate PR Title
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR Title
        uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Allow WIP PRs
          wip: true
          # Custom types if needed (defaults to conventional commits)
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert

  suggest-commit:
    name: Suggest Squash Commit Message
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate suggested squash commit message
        id: suggest
        run: |
          # Get all commits in the PR
          COMMITS=$(git log origin/${{ github.base_ref }}..HEAD --pretty=format:"%s")
          
          # Count commit types
          FEAT_COUNT=$(echo "$COMMITS" | grep -cE "^feat" || true)
          FIX_COUNT=$(echo "$COMMITS" | grep -cE "^fix" || true)
          DOCS_COUNT=$(echo "$COMMITS" | grep -cE "^docs" || true)
          
          # Determine primary type (feat > fix > docs)
          if [ "$FEAT_COUNT" -gt 0 ]; then
            TYPE="feat"
          elif [ "$FIX_COUNT" -gt 0 ]; then
            TYPE="fix"
          elif [ "$DOCS_COUNT" -gt 0 ]; then
            TYPE="docs"
          else
            TYPE="chore"
          fi
          
          # Extract scopes from commits
          SCOPES=$(echo "$COMMITS" | grep -oE "^[^(]+\(([^)]+)\)" | sed 's/^[^(]*(\([^)]*\))/\1/' | sort -u | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g')
          
          # Build description from commit messages
          DESCRIPTIONS=$(echo "$COMMITS" | sed 's/^[^:]*: //' | head -5)
          
          # Create suggested message
          if [ -n "$SCOPES" ]; then
            SUGGESTED="$TYPE($SCOPES): "
          else
            SUGGESTED="$TYPE: "
          fi
          
          # Use PR title if available, otherwise combine first few commit descriptions
          if [ -n "${{ github.event.pull_request.title }}" ]; then
            PR_TITLE="${{ github.event.pull_request.title }}"
            # Remove type prefix if present
            PR_TITLE=$(echo "$PR_TITLE" | sed 's/^[^:]*: //')
            SUGGESTED="${SUGGESTED}${PR_TITLE}"
          else
            FIRST_DESC=$(echo "$DESCRIPTIONS" | head -1)
            SUGGESTED="${SUGGESTED}${FIRST_DESC}"
          fi
          
          # Add body with commit details
          BODY=""
          while IFS= read -r commit; do
            if [ -n "$commit" ]; then
              # Extract description (remove type and scope)
              DESC=$(echo "$commit" | sed 's/^[^:]*: //')
              BODY="${BODY}- ${DESC}\n"
            fi
          done <<< "$COMMITS"
          
          # Limit to first 10 commits
          BODY=$(echo -e "$BODY" | head -10)
          
          # Create full message
          FULL_MESSAGE="${SUGGESTED}\n\n${BODY}"
          
          # Output for GitHub Actions
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FULL_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Also output as comment
          echo "SUGGESTED_MESSAGE<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FULL_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR with suggested message
        uses: actions/github-script@v7
        if: github.event.action != 'synchronize'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = `## ðŸ’¡ Suggested Squash Commit Message
            
            When you merge this PR with squash, use this commit message:
            
            \`\`\`
            ${{ steps.suggest.outputs.message }}
            \`\`\`
            
            **Note:** GitHub will use your PR title as the default squash commit message. Make sure your PR title follows Conventional Commits format:
            - \`feat(scope): description\`
            - \`fix(scope): description\`
            - \`docs(scope): description\`
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

